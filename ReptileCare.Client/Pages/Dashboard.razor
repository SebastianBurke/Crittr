@page "/"
@using ReptileCare.Client.Services
@using ReptileCare.Shared.DTOs
@inject ReptileService ReptileService
@inject EnclosureService EnclosureService
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<div class="relative w-full text-center mt-8">
    @if (isLoading)
    {
        <p><em>Loading...</em></p>
    }
    else if (!isAuthenticated)
    {
        <p>Please <a href="/login" class="text-blue-500 underline">log in</a> to view your reptiles and enclosures.</p>
    }
    else
    {
        <div class="relative">
            @if (currentCardIndex < enclosures.Count)
            {
                // Render an existing enclosure card
                var enclosure = enclosures[currentCardIndex];
                var enclosureReptiles = reptiles.Where(r => r.EnclosureProfileId == enclosure.Id).ToList();
                <div
                    class="max-w-xl mx-auto bg-gray-100 dark:bg-gray-700 border-2 border-green-400 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold mb-1">@enclosure.Name</h2>

                    @if (enclosureReptiles.Count == 0)
                    {
                        <div class="mt-4 text-gray-400 italic">No critters here yet... it's a bit too quiet.</div>
                        <button class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                                @onclick="ShowAddReptileModal">Add a Critter
                        </button>
                    }
                    else
                    {
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            @foreach (var reptile in enclosureReptiles)
                            {
                                <div class="bg-white dark:bg-gray-800 border rounded p-3 text-left">
                                    <h3 class="text-lg font-semibold">@reptile.Name</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">@reptile.Species</p>
                                    <p class="text-xs text-gray-400">@("Last fed: " + (reptile.LastFeedingDate?.ToShortDateString() ?? "N/A"))</p>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div
                    class="max-w-xl mx-auto bg-gradient-to-br from-gray-100 to-green-100 dark:from-gray-700 dark:to-green-900 border-2 border-dashed border-green-400 rounded-xl flex flex-col justify-center items-center p-6">
                    <h2 class="text-xl font-semibold mb-2">Your next enclosure awaits</h2>
                    <p class="text-gray-500 mb-4">Let's build a new home for your critters. Each habitat tells a
                        story.</p>
                    <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                            @onclick="ShowAddEnclosureModal">Add an Enclosure
                    </button>
                </div>
            }
        </div>

        <nav class="flex justify-center gap-2 mt-4" aria-label="Enclosure navigation">
            @for (int i = 0; i <= enclosures.Count; i++)
            {
                int index = i; // Capture the loop variable
                bool isAddNew = (i == enclosures.Count);
                string label = isAddNew ? "Add New Enclosure" : $"View enclosure: {enclosures[i].Name}";
                <button
                    class="w-4 h-4 rounded-full border-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 @(i == currentCardIndex ? (isAddNew ? "bg-green-300 border-green-600" : "bg-green-500 border-green-500") : "bg-gray-300 dark:bg-gray-600 border-transparent")"
                    aria-label="@label"
                    aria-current="@(i == currentCardIndex ? "true" : "false")"
                    @onclick="() => NavigateToCard(index)">
                </button>
            }
        </nav>
    }
</div>

@code {
    private bool isLoading = true;
    private bool isAuthenticated = false;
    private List<EnclosureProfileDto> enclosures = new();
    private List<ReptileDto> reptiles = new();
    private int currentCardIndex = 0;
    private int totalCards => enclosures.Count + 1;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await localStorage.ContainKeyAsync("authToken");
        if (isAuthenticated)
        {
            enclosures = await EnclosureService.GetEnclosuresAsync();
            reptiles = await ReptileService.GetReptilesAsync();
        }

        isLoading = false;
    }

    private void NavigateToCard(int index)
    {
        // Ensure the index is within bounds
        if (index >= 0 && index <= enclosures.Count)
        {
            currentCardIndex = index;
            StateHasChanged(); // Explicitly trigger UI update
        }
    }

    private void ShowAddEnclosureModal()
    {
        // TODO: Hook into modal
    }

    private void ShowAddReptileModal()
    {
        // TODO: Hook into modal
    }

}