@page "/"
@using ReptileCare.Client.Services
@using ReptileCare.Shared.DTOs
@using ReptileCare.Shared.Models
@inject ReptileService ReptileService
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<h2 class="text-2xl font-bold mb-4">My Reptiles Dashboard</h2>

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else if (!isAuthenticated)
{
    <p>Please <a href="/login" class="text-blue-500 underline">log in</a> to view your reptiles.</p>
}
else if (reptiles.Count == 0)
{
    <p>No reptiles found. Add a new one to get started!</p>
}
else
{
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @foreach (var reptile in reptiles)
        {
            <div class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-4 border dark:border-gray-700">
                <h3 class="text-lg font-semibold">@reptile.Name (@reptile.Species)</h3>
                <p class="text-sm text-gray-500">Acquired: @reptile.DateAcquired.ToShortDateString()</p>
                <ul class="mt-2 text-sm">
                    <li><strong>Last Fed:</strong> @(reptile.LastFeedingDate?.ToLocalTime().ToString("g") ?? "N/A")</li>
                    <li><strong>Weight Date:</strong> @(reptile.LastWeightDate?.ToLocalTime().ToString("g") ?? "N/A")</li>
                    <li><strong>Health Score:</strong> @(reptile.RecentHealthScore?.ToString() ?? "N/A")</li>
                    <li><strong>Pending Tasks:</strong> @reptile.PendingTasksCount</li>
                </ul>
            </div>
        }
    </div>
}

@code {
    private List<ReptileDto> reptiles = new();
    private bool isLoading = true;
    private bool isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        var token = await localStorage.GetItemAsync<string>("authToken");
        isAuthenticated = !string.IsNullOrWhiteSpace(token);

        if (isAuthenticated)
        {
            reptiles = await ReptileService.GetReptilesAsync();
        }

        isLoading = false;
    }
}

